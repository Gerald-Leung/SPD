\documentclass[12pt]{article}

% Gerald Leung, 2022.

%\usepackage{apacite}
%\usepackage[round]{natbib}
%\usepackage[colorlinks=true,linkcolor=blue]{hyperref}
\usepackage[a4paper, total={6in, 9.5in}]{geometry} % set the paper/text sizes

\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[english]{babel}
\usepackage[absolute,overlay]{textpos}
\usepackage{caption}
%\captionsetup{labelformat=empty,labelsep=none}
%\captionsetup{format=hang}
%\captionsetup{font=scriptsize}
\usepackage{amssymb}
\usepackage{tcolorbox}
\usepackage{tipa}
\usepackage{siunitx}
\usepackage{adjustbox}
\usepackage{setspace}
\usepackage{lipsum}
\usepackage{physics}
\usepackage{hyperref}
\usepackage{flowchart}
\usetikzlibrary{arrows}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{layout}
\usepackage{geometry}
%\geometry{left=12mm}
\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}


\hypersetup{colorlinks,
citecolor=blue,linkcolor=red, urlcolor=blue
}
\usepackage{qrcode}
\renewcommand{\vec}[1]{\boldsymbol{#1}}
\newcommand{\Hmns}{\tiny\textrm{H}}
\usepackage{media9}
\usepackage{aasmacros}
\usepackage{multimedia}
\usepackage{sidecap}
\usepackage{pdfpages}
\usepackage{xspace}
\usepackage{float}
%\usepackage{minted}
\usepackage{indentfirst}
\usepackage[round]{natbib}

%\usepackage[breaklinks,colorlinks,
   %urlcolor=blue,citecolor=blue,linkcolor=blue]{hyperref}
   

\newcommand{\bilby}{{\sc Bilby}\xspace}
\newcommand{\PyCBC}{{\sc PyCBC}\xspace}
\newcommand{\IPython}{{\sc IPython}\xspace}
\newcommand{\Python}{{\sc Python}\xspace}
\newcommand{\Numpy}{{\sc NumPy}\xspace}
\newcommand{\astropy}{{\sc Astropy}\xspace}
\newcommand{\R}{{\sc R}\xspace}


\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\ba}{\begin{eqnarray}}
\newcommand{\ea}{\end{eqnarray}}
\newcommand{\nn}{\nonumber}

\renewcommand{\arraystretch}{1.5}


\usepackage{etoolbox}

\makeatletter

% Patch case where name and year are separated by aysep
\patchcmd{\NAT@citex}
  {\@citea\NAT@hyper@{%
     \NAT@nmfmt{\NAT@nm}%
     \hyper@natlinkbreak{\NAT@aysep\NAT@spacechar}{\@citeb\@extra@b@citeb}%
     \NAT@date}}
  {\@citea\NAT@nmfmt{\NAT@nm}%
   \NAT@aysep\NAT@spacechar\NAT@hyper@{\NAT@date}}{}{}

% Patch case where name and year are separated by opening bracket
\patchcmd{\NAT@citex}
  {\@citea\NAT@hyper@{%
     \NAT@nmfmt{\NAT@nm}%
     \hyper@natlinkbreak{\NAT@spacechar\NAT@@open\if*#1*\else#1\NAT@spacechar\fi}%
       {\@citeb\@extra@b@citeb}%
     \NAT@date}}
  {\@citea\NAT@nmfmt{\NAT@nm}%
   \NAT@spacechar\NAT@@open\if*#1*\else#1\NAT@spacechar\fi\NAT@hyper@{\NAT@date}}
  {}{}

\makeatother


\usepackage{fancyhdr}
\fancypagestyle{CVfooter}
{
 \lhead{Gerald Leung}
 \chead{SPD Checks}
 \rhead{\today}
 \lfoot{\small{}}
 \cfoot{\small{}}
 \rfoot{\small{\thepage}}
 %\renewcommand{\headrulewidth}{0.5pt}
 %\renewcommand{\footrulewidth}{0.5pt}
}



\begin{document}
\title{Notes on Scottish Postcode Directory Quality Checking}
\author{Gerald Leung\\Public Health Scotland}
\date{Draft version: \today}
\maketitle
\tableofcontents
\section{Introduction}
\pagestyle{CVfooter}

In this short document, we summarise the process of
the Scottish Postcode Directory (SPD) file checks from the
National Records of Scotland (NRS) by the Geospatial Team at
Public Health Scotland (PHS). In short, NRS updates
SPD files twice a year, around March and September\footnote{\url{https://www.nrscotland.gov.uk/statistics-and-data/geography/nrs-postcode-extract}}. The Geospatial Team
will then conduct quality checks of the updated files
and compare any changes with the previous version.
They will then produce lookup files in various
formats, such as \texttt{.csv}. This
document focuses on summarising the processes of quality
checking (QC)
and lookup files production using \R.
Here we also reproduce a brief summary
of the data, which can be found in Appendix \ref{appendix:dict}.
Full details can be found through the \href{https://www.nrscotland.gov.uk/files//statistics/geography/2021-2/spd-datadictionary-2021-2.pdf}{data dictionary} provided by the NRS,
or accessed through
\begin{verbatim}
//PHIBCS/PHI/Referencing & Standards/GPD/1_Geography
/Scottish Postcode Directory/Source Data/2021_2
/ISD Data Dictionary_2021-2
\end{verbatim}
for the \textbf{2021-2} version.

\section{Initial Quality Checks}
The \R scripts are located in 
\begin{verbatim}
//PHIBCS/PHI/Referencing & Standards/GPD/5_GitHub/GPD/Geography
/Scottish Postcode Directory
\end{verbatim}
and the Standard Operating Procedures (SOPs) are located in
\begin{verbatim}
//PHIBCS/PHI/Referencing & Standards/GPD/1_Geography
/Scottish Postcode Directory/SOPs.
\end{verbatim}
The source files can be found in
\begin{verbatim}
//PHIBCS/PHI/Referencing & Standards/GPD/1_Geography
/Scottish Postcode Directory/Source Data.
\end{verbatim}
They can be accessed through the organisation's VPN.
The first QC is done through the \R script \texttt{1\_Check NRS SPD.R}.

In short, this script conducts a general initial
QC of the newest version of SPD files and compares
changes with the previous version. Figure \ref{fig:block1}
shows roughly the structure of the script and the QC process.

To start with, all empty rows contained in the files
are removed and the files are combined. The user will then
record the total number of records and postcode types.
Sanity checks are conducted to make sure there are
no blank entries for Health Board and Council Areas etc.
Checks are then carried out to make sure columns are
aligned correctly. For example, between Health Board Area
Code and Council Area Code columns. This is generally done
by assigning a number to the case when a particular
column does not have an expected code that should match
with the other column. 
During 2019, eight postcodes moved from Glasgow City Council to
North Lanarkshire Council. Extensive checks are then carried
out to make sure there are no blank fields. Checks are also
carried out to make sure there are no English voting codes included.
Finally, the script makes sure that mappings are done correctly,
such as Data Zones and Health Boards.

The script also makes comparisons with previous SPD files.
For instance,it checks for changes in postcodes
(some have been deleted), different data zones and
health boards etc.

\begin{figure}[h!]
%\centering
\begin{tikzpicture}[>=stealth, thick]

\node (P) at (-17,8) [text width=3cm, minimum height=0.8cm, align=flush center] 
{\texttt{Single Record CSV}\\(Combined)};

\node (A) at (-13,8) [draw, process, text width=2cm, minimum height=0.8cm, align=flush center] 
{Tidying and counting};

\node (B) at (-9,8)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
{Check column alignments};

%\node (B1) at (-4,9.5)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
%{\texttt{OUTCAR}};

\node (B2) at (-4,8)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
{Check for incorrect blank cells};

\node (B3) at (-4,5)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
{Check for blank fields};

\node (B4) at (-9,5)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
{Check for postcode types};

\node (B5) at (-13,5)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
{Check for geography aggregation};

\node (B6) at (-17,5)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
{Compare with previous version};

%\node (B3) at (-4,6.5)  [draw, process, text width=3cm, minimum height=0.8cm, align=flush center] 
%{\texttt{ORBCAR}};

%\draw[->] (A) to node[midway,above=0.3em,align=center]{test} (B);
%\draw[<-] (A)  --node[midway,above=0.3,align=center,text width=4cm]{Input parameters} [midway,below=0.3,align=center,text width=4cm]{Manual input} +(-180:4cm) ;
%\draw[<-] (A)  --node[above]{Input parameters} +(-180:4cm);
\draw[->] (P) -- (A);

\draw[->] (A) -- (B);
%\draw[->] (B) -- (B1);
\draw[->] (B) -- (B2);
%\draw[->] (B) -- (B3);
\draw[->] (B2) -- (B3);
\draw[->] (B3) -- (B4);
\draw[->] (B4) -- (B5);
\draw[->] (B5) -- (B6);


\end{tikzpicture}
\caption{Schematic diagram of the initial QC process.}\label{fig:block1}
\end{figure}

\begin{lstlisting}[language=R,frame=single]
checks <- function(variable1, variable2){
  
  spd %>% 
    mutate(check = case_when(variable1 == "" & variable2 != "" ~ 1, 
                             variable1 != "" & variable2 == "" ~ 2)) %>% 
    count(check) %>% 
    print()
  
}

\end{lstlisting}
 
\section{Lookup Files}
The next step of the process is to produce lookup files for
other uses and analysis within the organisation.


\newgeometry{left=10mm,right=40mm}

\appendix
\section{Appendix: Data Dictionary}\label{appendix:dict}
Here we reproduced and summarised the data dictionary provided by the NRS. Table {\ref{tab:SPD_DICT}} shows the rough definition of the data within \texttt{SingleRecord.csv}
in order.

\begin{longtable}{|| m{.55\textwidth} | m{.12\textwidth} | m{.47\textwidth}||} 
\hline
\textbf{Name} & \textbf{Type} & \textbf{Notes} \\
\hline\hline
Postcode & Character & The Royal Mail postcode. Consists of area, district, sector and unit. E.g. AB1 0AA.\\ \hline
SplitChar & Character & A, B, C \\ \hline
PostcodeDistrict & Character & Postcode District. E.g. AB1. \\ \hline
PostcodeSector & Character & Postcode Sector. E.g. AB1 0.\\ \hline
DateOfIntroduction & Date & Postcode introduction date. Currently shown as $\#\#\#\#$ instead of a date. \\ \hline
DateOfDeletion & Date & Postcode deletion date.
Similarly to date of introduction. \\ \hline
PostcodeType & Character & Small (S) or Large (L).\\ \hline
LinkedSmallUserPostcode & Character & Small User postcode that
contains the grid reference of the Large User postcode.\\ \hline
LinkedSmallUserPostcodeSplitChar & Character & A, B, C\\ \hline
Imputed & Character & Whether postcode's higher area values
have been inputed.\\ \hline
DeliveryPointCount & Integer & The Royal Mail delivery point count.\\ \hline
DeliveryPointCountNonResidential & Integer & Non-residential delivery point count.\\ \hline
HouseholdCount & Integer & The Royal Mail Household count.\\ \hline
GridReferenceEasting & Character & Grid reference easting.\\ \hline
GridReferenceNorthing & Character & Grid reference northing.\\ \hline
Latitude & Numeric & Coordinates in degrees.\\ \hline
Longitude & Numeric & Coordinates in degrees.\\ \hline
SplitIndicator & Character & Split postcode indicator. Y/N.\\ \hline
CouncilArea2019Code & Character & Identifies a 2019 Council Area.\\ \hline
UKParliamentaryConstituency2005Code & Character & 2005 UK Parliamentary Constituency.\\ \hline
ScottishParliamentaryRegion2021Code & Character & 2021 Scottish Parliamentary Region.\\ \hline
ScottishParliamentaryConstituency2021Code & Character & 2021 Scottish Parliamentary Constituency.\\ \hline
ElectoralWard2019Code & Character & 2019 Electoral Ward.\\ \hline
HealthBoardArea2019Code & Character & 2019 Health Board.\\ \hline
HealthBoardArea2006Code & Character & 2006 Health Board.\\ \hline
HealthBoardArea1995Code & Character & 1995 Health Board.\\ \hline
IntegrationAuthority2019Code & Character & 2019 Health and Social Care Partnership.\\ \hline
OutputArea2011Code & Character & 2011 Census Output Area.\\ \hline
OutputArea2001Code & Character & 2001 Census Output Area.\\ \hline
OutputArea1991Code & Character & 1991 Census Output Area.\\ \hline
DataZone2011Code & Character & 2011 Data Zone built from 2011 Output Areas.\\ \hline
DataZone2001Code & Character & 2001 Data Zone built from 2001 Output Areas.\\ \hline
IntermediateZone2011Code & Character & 2011 Intermediate Zone built from 2011 Data Zones.\\ \hline
IntermediateZone2001Code & Character & 2001 Intermediate Zone built from 2001 Data Zones.\\ \hline
CensusHouseholdCount2011 & Integer & 2011 Census postcode household count.\\ \hline
CensusPopulationCount2011 & Integer & 2011 Census postcode residential count.\\ \hline
CensusHouseholdCount2001 & Integer & 2001 Census postcode household count.\\ \hline
CensusPopulationCount2001 & Integer & 2001 Census postcode residential count.\\ \hline
CensusHouseholdCount1991 & Integer & 1991 Census postcode usually resident household count.\\ \hline
CensusPopulationCount1991 & Integer & 1991 Census postcode residential count.\\ \hline
ScottishIndexOfMultipleDeprivation2020Rank & Character & Rank Data Zones (2011) according to deprivation.\\ \hline
LAU2019Level1Code & Character & European Area Classification Local Administrative Unit (LAU) 2019 level 1. E.g. Council areas.\\ \hline
NUTS2018Level2Code & Character & European Area Classification Nomenclature of Territorial Units for Statistics (NUTS) 2018 level 2.\\ \hline
NUTS2018Level3Code & Character & European Area Classification Nomenclature of Territorial Units for Statistics (NUTS) 2018 level 3.\\ \hline
Locality2016Code & Character & 2016 Locality code.\\ \hline
Locality2001Code & Character & 2001 Locality code.\\ \hline
Locality1991Code & Character & 1991 Locality code.\\ \hline
Settlement2016Code & Character & 2016 Settlement code.\\ \hline
Settlement2001Code & Character & 2001 Settlement code.\\ \hline
CivilParish1930Code & Character & 1930 Civil Parish code.\\ \hline
EnterpriseRegion2008Code & Character & 2008 Scottish Enterprise Region code.\\ \hline
Islands2021Code & Character & Island identification code.\\ \hline
LocalGovernmentDistrict1995Code & Character & 1995 Local Government District code.\\ \hline
LocalGovernmentDistrict1991Code & Character & 1991 Local Government District code.\\ \hline
NationalPark2010Code & Character & 2010 National Park code.\\ \hline
RegistrationDistrict2007Code & Character & 2019 Council Area (same as Council Area boundaries).\\ \hline
ROACommunityPlanningPartnership2006Code & Character & 2006 Regeneration Outcome Area Community Planning Partnerships (CPP) code.\\ \hline
ROALocal2006Code & Character & 2006 Regeneration Outcome Area Local code.\\ \hline
StrategicDevelopmentPlanningArea2013Code & Character & 2013 Strategic Development Planning Area code.\\ \hline
TravelToWorkArea2011Code & Character & 2011 Travel to Work Area code.\\ \hline
UrbanRural6Fold2016Code & Character & Standard definition of rural Scotland following the Scottish Government Urban Rural classification (6 fold).\\ \hline
UrbanRural8Fold2016Code & Character & Similarly to above (8 fold).\\ \hline
GrudLinkIndicator & Character & Whether grid reference has been assigned via GridLink (Y/N).\\ \hline
GridLinkPositionalAccuracy & Character & Positional accuracy of the GridLink grid reference allocated to each postcode. See full dictionary for details.\\ \hline
NeverDigitised & Character & Whether a postcode boundary has been digitised (Y/N).\\ \hline
CouncilArea2011Code & Character & 2011 Council Area code.\\ \hline
HealthBoardArea2014Code & Character & 2014 Health Board code.\\ \hline
IntegrationAuthority2016Code & Character & 2016 Integration Authority code (Health and Social Care Partnership).\\ \hline
CouncilArea2018Code & Character & 2018 Council Area code.\\ \hline
HealthBoardArea2018Code & Character & 2018 Health Board code.\\ \hline
IntegrationAuthority2018Code & Character & 2018 Integration Authority code (Health and Social Care Partnership).\\ \hline
UrbanRural2Fold2016Code & Character & Standard definition of rural Scotland following the Scottish Government Urban Rural classification (2 fold).\\ \hline
UrbanRural3Fold2016Code & Character & Similarly to above (3 fold).\\ \hline
CommunityHealthPartnership2012Code & Character & 2012 Community Health Partnership code.\\ \hline
CommunityHealthPartnership2011Code & Character & 2011 Community Health Partnership code.\\ \hline
CommunityHealthPartnershipSubAreas2011Code & Character & 2011 Community Health Partnership sub sector code.\\ \hline
CommunityHealthPartnership2007Code & Character & 2007 Community Health Partnership code.\\ \hline
CommunityHealthPartnership2004Code & Character & 2004 Community Health Partnership code.\\ \hline




\caption{Data dictionary of the SPD file. Reproduced from NRS.} % needs to go inside longtable environment
\label{tab:SPD_DICT}
\end{longtable}
%\restoregeometry
%\end{table} 


%\bibliographystyle{ieeetr}
%\bibliographystyle{yahapj}
%\bibliography{slidescites}


\end{document}